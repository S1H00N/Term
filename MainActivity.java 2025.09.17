package com.example.alarm;

import android.app.AlarmManager;
import android.app.PendingIntent;
import android.app.TimePickerDialog;
import android.content.Context;
import android.content.Intent;
import android.os.Build;
import android.os.Bundle;
import android.provider.Settings;
import android.util.Log;
import android.widget.Button;
import android.widget.Toast;

import androidx.activity.EdgeToEdge;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.Insets;
import androidx.core.view.ViewCompat;
import androidx.core.view.WindowInsetsCompat;

import java.util.Calendar;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        // 화면을 엣지 투 엣지(상태바, 내비게이션바까지 차지하는 레이아웃)로 설정
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_main);

        // 시스템 UI(상단바, 하단바)의 여백을 자동으로 적용
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -> {
            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);
            return insets;
        });

        // 1. 레이아웃의 버튼을 코드와 연결
        Button timePickerButton = findViewById(R.id.timePickerButton);

        // 2. 버튼 클릭 시 동작 정의
        timePickerButton.setOnClickListener(v -> {
            // 현재 시각을 기본값으로 하는 Calendar 객체 생성
            Calendar now = Calendar.getInstance();

            // 시간 선택 다이얼로그(TimePickerDialog) 생성
            TimePickerDialog timePicker = new TimePickerDialog(
                    this,
                    (view, hourOfDay, minute) -> {
                        // 사용자가 시간을 선택했을 때 호출되는 콜백
                        Log.d("MainActivity", "선택된 시간: " + hourOfDay + "시 " + minute + "분");

                        // 권한 확인 후 알람 설정 진행
                        checkPermissionAndSetAlarm(hourOfDay, minute);
                    },
                    now.get(Calendar.HOUR_OF_DAY),    // 기본 시(hour)
                    now.get(Calendar.MINUTE),         // 기본 분(minute)
                    false     // false면 24시간제, true면 12시간제(AM/PM)
            );

            // 다이얼로그 표시
            timePicker.show();
        });
    }

     /**
         * 3. 알람 설정 전 권한 확인
         * - Android 12(S) 이상부터는 "정확한 알람" 권한 필요
         */

    private void checkPermissionAndSetAlarm(int hourOfDay, int minute) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            AlarmManager alarmManager = (AlarmManager) getSystemService(Context.ALARM_SERVICE);

            // 정확한 알람 권한 확인
            if (!alarmManager.canScheduleExactAlarms()) {
                // 권한이 없다면 권한 설정 화면으로 이동
                Intent intent = new Intent(Settings.ACTION_REQUEST_SCHEDULE_EXACT_ALARM);
                startActivity(intent);
            } else {
                // 권한이 있으면 알람 설정
                setAlarm(hourOfDay, minute);
            }
        } else {
            // Android 12 미만은 권한 필요 없음 → 바로 알람 설정
            setAlarm(hourOfDay, minute);
        }
    }

     /**
     * 4. 실제 알람 설정 메소드
     */

    private void setAlarm(int hourOfDay, int minute) {
        // Calendar 객체를 사용해 알람 시간 설정
        Calendar calendar = Calendar.getInstance();
        calendar.set(Calendar.HOUR_OF_DAY, hourOfDay);
        calendar.set(Calendar.MINUTE, minute);
        calendar.set(Calendar.SECOND, 0);

        // 현재 시각보다 이전이면 다음 날로 예약
        if (calendar.before(Calendar.getInstance())) {
            calendar.add(Calendar.DATE, 1);
        }

        // AlarmManager 설정
        AlarmManager alarmManager = (AlarmManager) getSystemService(Context.ALARM_SERVICE);

        // 알람이 울릴 때 실행할 BroadcastReceiver 지정
        Intent intent = new Intent(this, AlarmReceiver.class);
        PendingIntent pendingIntent = PendingIntent.getBroadcast(
                this,
                1, // requestCode (알람 구분용)
                intent, 
                PendingIntent.FLAG_IMMUTABLE     // Android 12 이상에서 필요
        ); 

        // 알람 등록
        alarmManager.setExactAndAllowWhileIdle(
                AlarmManager.RTC_WAKEUP,     // 기기의 실제 시간(RTC)을 기준으로 기기 깨움
                calendar.getTimeInMillis(),  // 알람 실행 시각
                pendingIntent
        );

        //사용자에게 알림
        Toast.makeText(this, "알람이 " + hourOfDay + "시 " + minute + "분에 설정되었습니다.", Toast.LENGTH_SHORT).show();
        Log.d("MainActivity", "알람이 " + calendar.getTime() + "에 설정되었습니다.");
    }
}
